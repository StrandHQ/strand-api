files:
  "/opt/python/etc/celery.conf":
    mode: "000755"
    owner: root
    group: root
    content: |
      ; ========================
      ;  celery beat supervisor
      ; ========================

      [program:celerybeat]
      ; Load environmental variables and start beat
      command=/bin/bash -c "source /opt/python/current/env && /opt/python/run/venv/bin/celery beat -A app"

      ; Full path to Django app
      directory=/opt/python/current/app
      user=nobody
      numprocs=1
      stdout_logfile=/var/log/celerybeat.log
      stderr_logfile=/var/log/celerybeat.log
      autostart=true
      autorestart=true
      startsecs=10

      ; Set its priority higher so it starts first
      priority=999

      ; ==========================
      ;  celery worker supervisor
      ; ==========================

      [program:celeryworker]
      ; Load environmental variables and start worker
      command=/bin/bash -c "source /opt/python/current/env && /opt/python/run/venv/bin/celery -A app worker -l info"

      ; Full path to Django app
      directory=/opt/python/current/app
      user=nobody
      numprocs=1
      stdout_logfile=/var/log/celeryworker.log
      stderr_logfile=/var/log/celeryworker.log
      autostart=true
      autorestart=true
      startsecs=10

      ; Set its priority higher so it starts first
      priority=999

container_commands:
  01_add_celery_to_supervisord:
    command: >
      if ! grep -Fxq "[include]" /opt/python/etc/supervisord.conf
          then
          echo "" | tee -a /opt/python/etc/supervisord.conf
          echo "[include]" | tee -a /opt/python/etc/supervisord.conf
          echo "files: celery.conf" | tee -a /opt/python/etc/supervisord.conf
      fi

      # Reread the supervisord config
      supervisorctl -c /opt/python/etc/supervisord.conf reread

      # Update supervisord in cache without restarting all services
      supervisorctl -c /opt/python/etc/supervisord.conf update
    leader_only: true

  02_kill_previous_beats:
    command: "ps auxww | grep 'celery beat' | awk '{print $2}' | sudo xargs kill -9 || true"
    ignoreErrors: true

  03_restart_celery_beat:
    command: "supervisorctl -c /opt/python/etc/supervisord.conf restart celerybeat"
    leader_only: true

  04_restart_celery_worker:
    command: "supervisorctl -c /opt/python/etc/supervisord.conf restart celeryworker"
    leader_only: true
